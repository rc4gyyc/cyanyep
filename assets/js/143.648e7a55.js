(window.webpackJsonp=window.webpackJsonp||[]).push([[143],{510:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("RestClient操作文档")]),t._v(" "),s("p",[t._v("索引库准备好以后，就可以操作文档了。为了与索引库操作分离，我们再次创建一个测试类，做两件事情：")]),t._v(" "),s("ul",[s("li",[t._v("初始化RestHighLevelClient")]),t._v(" "),s("li",[t._v("我们的商品数据在数据库，需要利用IHotelService去查询，所以注入这个接口")])]),t._v(" "),s("h2",{attrs:{id:"新增文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新增文档"}},[t._v("#")]),t._v(" 新增文档")]),t._v(" "),s("p",[t._v("将数据库中的商品信息导入elasticsearch中")]),t._v(" "),s("h3",{attrs:{id:"实体类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实体类"}},[t._v("#")]),t._v(" 实体类")]),t._v(" "),s("p",[t._v("索引库结构与数据库结构还存在一些差异，因此我们要定义一个索引库结构对应的实体。")]),t._v(" "),s("h3",{attrs:{id:"api语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#api语法"}},[t._v("#")]),t._v(" API语法")]),t._v(" "),s("p",[t._v("新增文档的请求语法如下：")]),t._v(" "),s("div",{staticClass:"language-JSON extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("POST /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("索引库名"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/_doc/"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Jack"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"age"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("对应的JavaAPI如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"C:%5CUsers%5C86157%5CDesktop%5Cblog-img%5Cimg%5C1746167247627-1.png",alt:"img"}})]),t._v(" "),s("p",[t._v("与索引库操作的API非常类似，同样是三步走：")]),t._v(" "),s("ul",[s("li",[t._v("1）创建Request对象，这里是"),s("code",[t._v("IndexRequest")]),t._v("，因为添加文档就是创建倒排索引的过程")]),t._v(" "),s("li",[t._v("2）准备请求参数，本例中就是Json文档")]),t._v(" "),s("li",[t._v("3）发送请求")])]),t._v(" "),s("p",[t._v("这里直接使用"),s("code",[t._v("client.xxx()")]),t._v("的API，不再需要"),s("code",[t._v("client.indices()")]),t._v("了。")]),t._v(" "),s("h3",{attrs:{id:"完整代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#完整代码"}},[t._v("#")]),t._v(" 完整代码")]),t._v(" "),s("p",[t._v("准备工作：")]),t._v(" "),s("ul",[s("li",[t._v("商品数据来自于数据库，我们需要先查询出来，得到"),s("code",[t._v("Item")]),t._v("对象")]),t._v(" "),s("li",[s("code",[t._v("Item")]),t._v("对象需要转为"),s("code",[t._v("ItemDoc")]),t._v("对象")]),t._v(" "),s("li",[s("code",[t._v("ItemDTO")]),t._v("需要序列化为"),s("code",[t._v("json")]),t._v("格式")])]),t._v(" "),s("p",[t._v("代码整体步骤如下：")]),t._v(" "),s("ul",[s("li",[t._v("1）根据id查询商品数据"),s("code",[t._v("Item")])]),t._v(" "),s("li",[t._v("2）将"),s("code",[t._v("Item")]),t._v("封装为"),s("code",[t._v("ItemDoc")])]),t._v(" "),s("li",[t._v("3）将"),s("code",[t._v("ItemDoc")]),t._v("序列化为JSON")]),t._v(" "),s("li",[t._v("4）创建IndexRequest，指定索引库名和id")]),t._v(" "),s("li",[t._v("5）准备请求参数，也就是JSON文档")]),t._v(" "),s("li",[t._v("6）发送请求")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("item-service")]),t._v("的"),s("code",[t._v("DocumentTest")]),t._v("测试类中，编写单元测试：")]),t._v(" "),s("div",{staticClass:"language-Java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("testAddDocument")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IOException")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.根据id查询商品数据")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Item")]),t._v(" item "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" itemService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100002644680L")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.转换为文档类型")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ItemDoc")]),t._v(" itemDoc "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BeanUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("copyProperties")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ItemDoc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.将ItemDTO转json")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" doc "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JSONUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toJsonStr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("itemDoc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.准备Request对象")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IndexRequest")]),t._v(" request "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IndexRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"items"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("itemDoc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.准备Json文档")]),t._v("\n    request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("source")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("doc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("XContentType")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.发送请求")]),t._v("\n    client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RequestOptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DEFAULT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"查询文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询文档"}},[t._v("#")]),t._v(" 查询文档")]),t._v(" "),s("p",[t._v("我们以根据id查询文档为例")]),t._v(" "),s("h3",{attrs:{id:"语法说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#语法说明"}},[t._v("#")]),t._v(" 语法说明")]),t._v(" "),s("p",[t._v("查询的请求语句如下：")]),t._v(" "),s("div",{staticClass:"language-JSON extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("GET /"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("索引库名"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/_doc/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("与之前的流程类似，代码大概分2步：")]),t._v(" "),s("ul",[s("li",[t._v("创建Request对象")]),t._v(" "),s("li",[s("s",[t._v("准备请求参数，这里是无参，直接省略")])]),t._v(" "),s("li",[t._v("发送请求")])]),t._v(" "),s("p",[t._v("不过查询的目的是得到结果，解析为ItemDTO，还要再加一步对结果的解析。示例代码如下：")]),t._v(" "),s("p",[s("img",{attrs:{src:"C:%5CUsers%5C86157%5CDesktop%5Cblog-img%5Cimg%5C1746167558515-4.png",alt:"img"}})]),t._v(" "),s("p",[t._v("可以看到，响应结果是一个JSON，其中文档放在一个"),s("code",[t._v("_source")]),t._v("属性中，因此解析就是拿到"),s("code",[t._v("_source")]),t._v("，反序列化为Java对象即可。")]),t._v(" "),s("p",[t._v("其它代码与之前类似，流程如下：")]),t._v(" "),s("ul",[s("li",[t._v("1）准备Request对象。这次是查询，所以是"),s("code",[t._v("GetRequest")])]),t._v(" "),s("li",[t._v("2）发送请求，得到结果。因为是查询，这里调用"),s("code",[t._v("client.get()")]),t._v("方法")]),t._v(" "),s("li",[t._v("3）解析结果，就是对JSON做反序列化")])]),t._v(" "),s("h2",{attrs:{id:"删除文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除文档"}},[t._v("#")]),t._v(" 删除文档")]),t._v(" "),s("p",[t._v("删除的请求语句如下：")]),t._v(" "),s("div",{staticClass:"language-JSON extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[t._v("DELETE /hotel/_doc/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("与查询相比，仅仅是请求方式从"),s("code",[t._v("DELETE")]),t._v("变成"),s("code",[t._v("GET")]),t._v("，可以想象Java代码应该依然是2步走：")]),t._v(" "),s("ul",[s("li",[t._v("1）准备Request对象，因为是删除，这次是"),s("code",[t._v("DeleteRequest")]),t._v("对象。要指定索引库名和id")]),t._v(" "),s("li",[t._v("2）"),s("s",[t._v("准备参数，无参，直接省略")])]),t._v(" "),s("li",[t._v("3）发送请求。因为是删除，所以是"),s("code",[t._v("client.delete()")]),t._v("方法")])]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("item-service")]),t._v("的"),s("code",[t._v("DocumentTest")]),t._v("测试类中，编写单元测试：")]),t._v(" "),s("div",{staticClass:"language-Java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Test")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("testDeleteDocument")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IOException")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.准备Request，两个参数，第一个是索引库名，第二个是文档id")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DeleteRequest")]),t._v(" request "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DeleteRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"item"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"100002644680"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.发送请求")]),t._v("\n    client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("delete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RequestOptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DEFAULT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"修改文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改文档"}},[t._v("#")]),t._v(" 修改文档")]),t._v(" "),s("p",[t._v("修改我们讲过两种方式：")]),t._v(" "),s("ul",[s("li",[t._v("全量修改：本质是先根据id删除，再新增")]),t._v(" "),s("li",[t._v("局部修改：修改文档中的指定字段值")])]),t._v(" "),s("p",[t._v("在RestClient的API中，全量修改与新增的API完全一致，判断依据是ID：")]),t._v(" "),s("ul",[s("li",[t._v("如果新增时，ID已经存在，则修改")]),t._v(" "),s("li",[t._v("如果新增时，ID不存在，则新增")])])])}),[],!1,null,null,null);s.default=e.exports}}]);