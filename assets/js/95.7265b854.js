(window.webpackJsonp=window.webpackJsonp||[]).push([[95],{467:function(s,t,a){"use strict";a.r(t);var e=a(1),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis集群"}},[s._v("#")]),s._v(" Redis集群")]),s._v(" "),t("p",[s._v("本章是基于CentOS7下的Redis集群教程，包括：")]),s._v(" "),t("ul",[t("li",[s._v("单机安装Redis")]),s._v(" "),t("li",[s._v("Redis主从")]),s._v(" "),t("li",[s._v("Redis分片集群")])]),s._v(" "),t("h1",{attrs:{id:"_1-单机安装redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-单机安装redis"}},[s._v("#")]),s._v(" 1.单机安装Redis")]),s._v(" "),t("p",[s._v("首先需要安装Redis所需要的依赖：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" gcc tcl\n")])])]),t("p",[s._v("然后将课前资料提供的Redis安装包上传到虚拟机的任意目录：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210629114325516.png",alt:"image-20210629114325516"}})]),s._v(" "),t("p",[s._v("例如，我放到了/tmp目录：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210629114830642.png",alt:"image-20210629114830642"}})]),s._v(" "),t("p",[s._v("解压缩：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-xzf")]),s._v(" redis-6.2.4.tar.gz\n")])])]),t("p",[s._v("解压后：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210629114941810.png",alt:"image-20210629114941810"}})]),s._v(" "),t("p",[s._v("进入redis目录：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" redis-6.2.4\n")])])]),t("p",[s._v("运行编译命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])])]),t("p",[s._v("如果没有出错，应该就安装成功了。")]),s._v(" "),t("p",[s._v("然后修改redis.conf文件中的一些配置：")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 绑定地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("bind")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0.0.0.0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保护模式，关闭保护模式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("protected-mode")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("no")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据库数量，设置为1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("databases")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n")])])]),t("p",[s._v("启动Redis：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("redis-server redis.conf\n")])])]),t("p",[s._v("停止redis服务：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("redis-cli "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("\n")])])]),t("h1",{attrs:{id:"_2-redis主从集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis主从集群"}},[s._v("#")]),s._v(" 2.Redis主从集群")]),s._v(" "),t("h2",{attrs:{id:"_2-1-集群结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-集群结构"}},[s._v("#")]),s._v(" 2.1.集群结构")]),s._v(" "),t("p",[s._v("我们搭建的主从集群结构如图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210725152037611.png",alt:"image-20210725152037611"}})]),s._v(" "),t("p",[s._v("共包含三个节点，一个主节点，两个从节点。")]),s._v(" "),t("p",[s._v("这里我们会在同一台虚拟机中开启3个redis实例，模拟主从集群，信息如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"center"}},[s._v("IP")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("PORT")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("角色")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("7001")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("master")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("7002")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("7003")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])])])]),s._v(" "),t("h2",{attrs:{id:"_2-2-准备实例和配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-准备实例和配置"}},[s._v("#")]),s._v(" 2.2.准备实例和配置")]),s._v(" "),t("p",[s._v("要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。")]),s._v(" "),t("p",[s._v("1）创建目录")]),s._v(" "),t("p",[s._v("我们创建三个文件夹，名字分别叫7001、7002、7003：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n")])])]),t("p",[s._v("如图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210630113929868.png",alt:"image-20210630113929868"}})]),s._v(" "),t("p",[s._v("2）恢复原始配置")]),s._v(" "),t("p",[s._v("修改redis-6.2.4/redis.conf文件，将其中的持久化模式改为默认的RDB模式，AOF保持关闭状态。")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启RDB")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# save ""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("save")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("3600 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("save")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("300 100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("save")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("60 10000")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭AOF")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("appendonly")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("no")]),s._v("\n")])])]),t("p",[s._v("3）拷贝配置文件到每个实例目录")]),s._v(" "),t("p",[s._v("然后将redis-6.2.4/redis.conf文件拷贝到三个目录中（在/tmp目录执行下列命令）：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式一：逐个拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式二：管道组合命令，一键拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis-6.2.4/redis.conf\n")])])]),t("p",[s._v("4）修改每个实例的端口、工作目录")]),s._v(" "),t("p",[s._v("修改每个文件夹内的配置文件，将端口分别修改为7001、7002、7003，将rdb文件保存位置都修改为自己所在目录（在/tmp目录执行下列命令）：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/7001/g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/dir .\\//dir \\/tmp\\/7001\\//g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("/redis.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/7002/g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/dir .\\//dir \\/tmp\\/7002\\//g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("/redis.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/7003/g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/dir .\\//dir \\/tmp\\/7003\\//g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("/redis.conf\n")])])]),t("p",[s._v("5）修改每个实例的声明IP")]),s._v(" "),t("p",[s._v("虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis实例的声明 IP")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("replica-announce-ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("192.168.150.101")]),s._v("\n")])])]),t("p",[s._v("每个目录都要改，我们一键完成修改（在/tmp目录执行下列命令）：1a在第一行后追加")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 逐一执行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("/redis.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("/redis.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("/redis.conf\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者一键修改")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1a replica-announce-ip 192.168.150.101'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/redis.conf\n")])])]),t("h2",{attrs:{id:"_2-3-启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-启动"}},[s._v("#")]),s._v(" 2.3.启动")]),s._v(" "),t("p",[s._v("为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第1个")]),s._v("\nredis-server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("/redis.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第2个")]),s._v("\nredis-server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("/redis.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第3个")]),s._v("\nredis-server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("/redis.conf\n")])])]),t("p",[s._v("启动后：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210630183914491.png",alt:"image-20210630183914491"}})]),s._v(" "),t("p",[s._v("如果要一键停止，可以运行下面命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("\n")])])]),t("h2",{attrs:{id:"_2-4-开启主从关系"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-开启主从关系"}},[s._v("#")]),s._v(" 2.4.开启主从关系")]),s._v(" "),t("p",[s._v("现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。")]),s._v(" "),t("p",[s._v("有临时和永久两种模式：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("修改配置文件（永久生效）")]),s._v(" "),t("ul",[t("li",[s._v("在redis.conf中添加一行配置："),t("code",[s._v("slaveof <masterip> <masterport>")])])])]),s._v(" "),t("li",[t("p",[s._v("使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("slaveof "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("masterip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("masterport"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])])])]),s._v(" "),t("p",[t("strong",[t("font",{attrs:{color:"red"}},[s._v("注意")])],1),s._v("：在5.0以后新增命令replicaof，与salveof效果一致。")]),s._v(" "),t("p",[s._v("这里我们为了演示方便，使用方式二。")]),s._v(" "),t("p",[s._v("通过redis-cli命令连接7002，执行下面命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 7002")]),s._v("\nredis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行slaveof")]),s._v("\nslaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n")])])]),t("p",[s._v("通过redis-cli命令连接7003，执行下面命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 7003")]),s._v("\nredis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行slaveof")]),s._v("\nslaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n")])])]),t("p",[s._v("然后连接 7001节点，查看集群状态：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 7001")]),s._v("\nredis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看状态")]),s._v("\ninfo replication\n")])])]),t("p",[s._v("注意：这里的节点不能有密码，不然会设置失败**")]),s._v(" "),t("p",[s._v("如果需要，在从节点设置连接主节点使用的密码")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定主节点的 IP 地址和端口")]),s._v("\nslaveof your_master_ip your_master_port\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置连接主节点所需的密码")]),s._v("\nmasterauth your_master_password\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果你希望从节点也受到密码保护，可以设置 requirepass")]),s._v("\nrequirepass your_slave_password\n")])])]),t("p",[s._v("结果：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210630201258802.png",alt:"image-20210630201258802"}})]),s._v(" "),t("h2",{attrs:{id:"_2-5-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-测试"}},[s._v("#")]),s._v(" 2.5.测试")]),s._v(" "),t("p",[s._v("执行下列操作以测试：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("利用redis-cli连接7001，执行"),t("code",[s._v("set num 123")])])]),s._v(" "),t("li",[t("p",[s._v("利用redis-cli连接7002，执行"),t("code",[s._v("get num")]),s._v("，再执行"),t("code",[s._v("set num 666")])])]),s._v(" "),t("li",[t("p",[s._v("利用redis-cli连接7003，执行"),t("code",[s._v("get num")]),s._v("，再执行"),t("code",[s._v("set num 888")])])])]),s._v(" "),t("p",[s._v("可以发现，只有在7001这个master节点上可以执行写操作，7002和7003这两个slave节点只能执行读操作。")]),s._v(" "),t("h1",{attrs:{id:"_3-搭建哨兵集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-搭建哨兵集群"}},[s._v("#")]),s._v(" 3.搭建哨兵集群")]),s._v(" "),t("h2",{attrs:{id:"_3-1-集群结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-集群结构"}},[s._v("#")]),s._v(" 3.1.集群结构")]),s._v(" "),t("p",[s._v("这里我们搭建一个三节点形成的Sentinel集群，来监管之前的Redis主从集群。如图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210701215227018.png",alt:"image-20210701215227018"}})]),s._v(" "),t("p",[s._v("三个sentinel实例信息如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("节点")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("IP")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("PORT")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("s1")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("27001")])]),s._v(" "),t("tr",[t("td",[s._v("s2")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("27002")])]),s._v(" "),t("tr",[t("td",[s._v("s3")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("27003")])])])]),s._v(" "),t("h2",{attrs:{id:"_3-2-准备实例和配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-准备实例和配置"}},[s._v("#")]),s._v(" 3.2.准备实例和配置")]),s._v(" "),t("p",[s._v("要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。")]),s._v(" "),t("p",[s._v("我们创建三个文件夹，名字分别叫s1、s2、s3：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" s1 s2 s3\n")])])]),t("p",[s._v("如图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210701215534714.png",alt:"image-20210701215534714"}})]),s._v(" "),t("p",[s._v("然后我们在s1目录创建一个sentinel.conf文件，添加下面的内容：")]),s._v(" "),t("div",{staticClass:"language-ini extra-class"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[s._v('port 27001\nsentinel announce-ip 192.168.150.101\nsentinel monitor mymaster 192.168.150.101 7001 2\nsentinel down-after-milliseconds mymaster 5000\nsentinel failover-timeout mymaster 60000\ndir "/tmp/s1"\n')])])]),t("p",[s._v("解读：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("port 27001")]),s._v("：是当前sentinel实例的端口")]),s._v(" "),t("li",[t("code",[s._v("sentinel monitor mymaster 192.168.150.101 7001 2")]),s._v("：指定主节点信息\n"),t("ul",[t("li",[t("code",[s._v("mymaster")]),s._v("：主节点名称，自定义，任意写")]),s._v(" "),t("li",[t("code",[s._v("192.168.150.101 7001")]),s._v("：主节点的ip和端口")]),s._v(" "),t("li",[t("code",[s._v("2")]),s._v("：选举master时的quorum值")])])])]),s._v(" "),t("p",[s._v("然后将s1/sentinel.conf文件拷贝到s2、s3两个目录中（在/tmp目录执行下列命令）：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式一：逐个拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" s1/sentinel.conf s2\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" s1/sentinel.conf s3\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方式二：管道组合命令，一键拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" s2 s3 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" s1/sentinel.conf\n")])])]),t("p",[s._v("修改s2、s3两个文件夹内的配置文件，将端口分别修改为27002、27003：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/27001/27002/g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/s1/s2/g'")]),s._v(" s2/sentinel.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/27001/27003/g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/s1/s3/g'")]),s._v(" s3/sentinel.conf\n")])])]),t("h2",{attrs:{id:"_3-3-启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-启动"}},[s._v("#")]),s._v(" 3.3.启动")]),s._v(" "),t("p",[s._v("为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第1个")]),s._v("\nredis-sentinel s1/sentinel.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第2个")]),s._v("\nredis-sentinel s2/sentinel.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第3个")]),s._v("\nredis-sentinel s3/sentinel.conf\n")])])]),t("p",[s._v("启动后：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210701220714104.png",alt:"image-20210701220714104"}})]),s._v(" "),t("h2",{attrs:{id:"_3-4-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-测试"}},[s._v("#")]),s._v(" 3.4.测试")]),s._v(" "),t("p",[s._v("尝试让master节点7001宕机，查看sentinel日志：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210701222857997.png",alt:"image-20210701222857997"}})]),s._v(" "),t("p",[s._v("查看7003的日志：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210701223025709.png",alt:"image-20210701223025709"}})]),s._v(" "),t("p",[s._v("查看7002的日志：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210701223131264.png",alt:"image-20210701223131264"}})]),s._v(" "),t("h1",{attrs:{id:"_4-搭建分片集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-搭建分片集群"}},[s._v("#")]),s._v(" 4.搭建分片集群")]),s._v(" "),t("h2",{attrs:{id:"_4-1-集群结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-集群结构"}},[s._v("#")]),s._v(" 4.1.集群结构")]),s._v(" "),t("p",[s._v("分片集群需要的节点数量较多，这里我们搭建一个最小的分片集群，包含3个master节点，每个master包含一个slave节点，结构如下：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702164116027.png",alt:"image-20210702164116027"}})]),s._v(" "),t("p",[s._v("这里我们会在同一台虚拟机中开启6个redis实例，模拟分片集群，信息如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"center"}},[s._v("IP")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("PORT")]),s._v(" "),t("th",{staticStyle:{"text-align":"center"}},[s._v("角色")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("7001")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("master")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("7002")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("master")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("7003")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("master")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("8001")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("8002")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"center"}},[s._v("192.168.150.101")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("8003")]),s._v(" "),t("td",{staticStyle:{"text-align":"center"}},[s._v("slave")])])])]),s._v(" "),t("h2",{attrs:{id:"_4-2-准备实例和配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-准备实例和配置"}},[s._v("#")]),s._v(" 4.2.准备实例和配置")]),s._v(" "),t("p",[s._v("删除之前的7001、7002、7003这几个目录，重新创建出7001、7002、7003、8001、8002、8003目录：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除旧的，避免配置干扰")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8003")]),s._v("\n")])])]),t("p",[s._v("在/tmp下准备一个新的redis.conf文件，内容如下：")]),s._v(" "),t("div",{staticClass:"language-ini extra-class"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[s._v("port 6379\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启集群功能")]),s._v("\ncluster-enabled yes\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群的配置文件名称，不需要我们创建，由redis自己维护")]),s._v("\ncluster-config-file /tmp/6379/nodes.conf\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 节点心跳失败的超时时间")]),s._v("\ncluster-node-timeout 5000\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久化文件存放目录")]),s._v("\ndir /tmp/6379\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 绑定地址")]),s._v("\nbind 0.0.0.0\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 让redis后台运行")]),s._v("\ndaemonize yes\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注册的实例ip")]),s._v("\nreplica-announce-ip 192.168.150.101\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保护模式")]),s._v("\nprotected-mode no\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据库数量")]),s._v("\ndatabases 1\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志")]),s._v("\nlogfile /tmp/6379/run.log\n")])])]),t("p",[s._v("将这个文件拷贝到每个目录下：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" redis.conf\n")])])]),t("p",[s._v("修改每个目录下的redis.conf，将其中的6379修改为与所在目录一致：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改配置文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/6379/{}/g'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/redis.conf\n")])])]),t("h2",{attrs:{id:"_4-3-启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-启动"}},[s._v("#")]),s._v(" 4.3.启动")]),s._v(" "),t("p",[s._v("因为已经配置了后台启动模式，所以可以直接启动服务：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入/tmp目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一键启动所有服务")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" redis-server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("/redis.conf\n")])])]),t("p",[s._v("通过ps查看状态：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" redis\n")])])]),t("p",[s._v("发现服务都已经正常启动：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702174255799.png",alt:"image-20210702174255799"}})]),s._v(" "),t("p",[s._v("如果要关闭所有进程，可以执行命令：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" redis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v("\n")])])]),t("p",[s._v("或者（推荐这种方式）：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("printf")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s\\n'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8002")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8003")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" -I"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("\n")])])]),t("h2",{attrs:{id:"_4-4-创建集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-创建集群"}},[s._v("#")]),s._v(" 4.4.创建集群")]),s._v(" "),t("p",[s._v("虽然服务启动了，但是目前每个服务之间都是独立的，没有任何关联。")]),s._v(" "),t("p",[s._v("我们需要执行命令来创建集群，在Redis5.0之前创建集群比较麻烦，5.0之后集群管理命令都集成到了redis-cli中。")]),s._v(" "),t("p",[s._v("1）Redis5.0之前")]),s._v(" "),t("p",[s._v("Redis5.0之前集群命令都是用redis安装包下的src/redis-trib.rb来实现的。因为redis-trib.rb是有ruby语言编写的所以需要安装ruby环境。")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装依赖")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" zlib ruby rubygems\ngem "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis\n")])])]),t("p",[s._v("然后通过命令来管理集群：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入redis的src目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp/redis-6.2.4/src\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建集群")]),s._v("\n./redis-trib.rb create "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:7001 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:7002 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:7003 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:8001 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:8002 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:8003\n")])])]),t("p",[s._v("2）Redis5.0以后")]),s._v(" "),t("p",[s._v("我们使用的是Redis6.2.4版本，集群管理以及集成到了redis-cli中，格式如下：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" create --cluster-replicas "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:7001 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:7002 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:7003 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:8001 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:8002 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.101:8003\n")])])]),t("p",[s._v("命令说明：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("redis-cli --cluster")]),s._v("或者"),t("code",[s._v("./redis-trib.rb")]),s._v("：代表集群操作命令")]),s._v(" "),t("li",[t("code",[s._v("create")]),s._v("：代表是创建集群")]),s._v(" "),t("li",[t("code",[s._v("--replicas 1")]),s._v("或者"),t("code",[s._v("--cluster-replicas 1")]),s._v(" ：指定集群中每个master的副本个数为1，此时"),t("code",[s._v("节点总数 ÷ (replicas + 1)")]),s._v(" 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master")])]),s._v(" "),t("p",[s._v("运行后的样子：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702181101969.png",alt:"image-20210702181101969"}})]),s._v(" "),t("p",[s._v("这里输入yes，则集群开始创建：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702181215705.png",alt:"image-20210702181215705"}})]),s._v(" "),t("p",[s._v("通过命令可以查看集群状态：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v(" cluster nodes\n")])])]),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702181922809.png",alt:"image-20210702181922809"}})]),s._v(" "),t("h2",{attrs:{id:"_4-5-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-测试"}},[s._v("#")]),s._v(" 4.5.测试")]),s._v(" "),t("p",[s._v("尝试连接7001节点，存储一个数据：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接")]),s._v("\nredis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 存储数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("123")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读取数据")]),s._v("\nget num\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次存储")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" a "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])])]),t("p",[s._v("结果悲剧了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702182343979.png",alt:"image-20210702182343979"}})]),s._v(" "),t("p",[s._v("集群操作时，需要给"),t("code",[s._v("redis-cli")]),s._v("加上"),t("code",[s._v("-c")]),s._v("参数才可以：")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\n")])])]),t("p",[s._v("这次可以了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://stofu80ry.sabkt.gdipper.com/picture/image-20210702182602145.png",alt:"image-20210702182602145"}})])])}),[],!1,null,null,null);t.default=r.exports}}]);