(window.webpackJsonp=window.webpackJsonp||[]).push([[154],{525:function(t,a,s){"use strict";s.r(a);var e=s(1),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"可靠性设置时注意"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可靠性设置时注意"}},[t._v("#")]),t._v(" 可靠性设置时注意")]),t._v(" "),a("h3",{attrs:{id:"生产者可靠性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生产者可靠性"}},[t._v("#")]),t._v(" 生产者可靠性")]),t._v(" "),a("p",[t._v("如果对于业务性能有要求，建议禁用"),a("strong",[t._v("生产者重试")]),t._v("机制。如果一定要使用，"),a("strong",[t._v("请合理配置等待时长和重试次数")]),t._v("，当然也可以考虑"),a("strong",[t._v("使用异步线程")]),t._v("来执行发送消息的代码。")]),t._v(" "),a("p",[t._v("修改"),a("code",[t._v("publisher")]),t._v("模块的"),a("code",[t._v("application.yaml")]),t._v("文件，添加下面的内容：")]),t._v(" "),a("div",{staticClass:"language-YAML extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rabbitmq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("connection-timeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1s "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置MQ的连接超时时间")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("retry")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启超时重试机制")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("initial-interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1000ms "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 失败后的初始等待时间")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("multiplier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max-attempts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 最大重试次数")]),t._v("\n")])])]),a("p",[t._v("开启"),a("strong",[t._v("生产者确认")]),t._v("比较消耗MQ性能，一般不建议开启。而且大家思考一下触发确认的几种情况：")]),t._v(" "),a("ul",[a("li",[t._v("路由失败：一般是因为RoutingKey错误导致，往往是编程导致")]),t._v(" "),a("li",[t._v("交换机名称错误：同样是编程错误导致")]),t._v(" "),a("li",[t._v("MQ内部故障：这种需要处理，但概率往往较低。因此"),a("strong",[t._v("只有对消息可靠性要求非常高的业务才需要开启")]),t._v("，"),a("strong",[t._v("而且仅仅需要开启ConfirmCallback处理nack就可以了")]),t._v("。")])]),t._v(" "),a("p",[t._v("在publisher模块的"),a("code",[t._v("application.yaml")]),t._v("中添加配置：")]),t._v(" "),a("div",{staticClass:"language-YAML extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rabbitmq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("publisher-confirm-type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" correlated "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启publisher confirm机制，并设置confirm类型")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("publisher-returns")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启publisher return机制")]),t._v("\n")])])]),a("h3",{attrs:{id:"mq可靠性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mq可靠性"}},[t._v("#")]),t._v(" MQ可靠性")]),t._v(" "),a("p",[t._v("在开启持久化机制以后，"),a("strong",[t._v("如果同时还开启了生产者确认，那么MQ会在消息持久化以后才发送ACK回执")]),t._v("，进一步确保消息的可靠性。")]),t._v(" "),a("h3",{attrs:{id:"消费者可靠性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#消费者可靠性"}},[t._v("#")]),t._v(" 消费者可靠性")]),t._v(" "),a("p",[t._v("SpringAMQP帮我们实现了消息确认。并允许我们通过配置文件设置ACK处理方式")]),t._v(" "),a("p",[t._v("通过下面的配置可以修改SpringAMQP的ACK处理方式：")]),t._v(" "),a("div",{staticClass:"language-YAML extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rabbitmq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("listener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("simple")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("acknowledge-mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" auto "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 自动ack")]),t._v("\n")])])]),a("p",[t._v("失败重试")]),t._v(" "),a("p",[t._v("修改consumer服务的application.yml文件，添加内容：")]),t._v(" "),a("div",{staticClass:"language-YAML extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rabbitmq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("listener")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("simple")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("retry")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启消费者失败重试")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("initial-interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1000ms "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 初识的失败等待时长为1秒")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("multiplier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 失败的等待时长倍数，下次等待时长 = multiplier * last-interval")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max-attempts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 最大重试次数")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stateless")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# true无状态；false有状态。如果业务中包含事务，这里改为false")]),t._v("\n")])])]),a("p",[t._v("失败处理策略")]),t._v(" "),a("p",[a("strong",[t._v("比较优雅的一种处理方案是"),a("code",[t._v("RepublishMessageRecoverer")]),t._v("，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。")])])])}),[],!1,null,null,null);a.default=n.exports}}]);